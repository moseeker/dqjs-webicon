# Publish to sandbox NPM registry
#
# Triggers after Build workflow completes successfully
# Publishes packages with 'sandbox' tag to private NPM registry
# Does NOT trigger on tag creation/push

name: Publish Sandbox

on:
  workflow_run:
    workflows: ["Build"]
    types:
      - completed
    branches:
      - main

jobs:
  publish:
    runs-on: ubuntu-latest
    # Only run if Build workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate sandbox version
        run: |
          # Get base version from package.json
          BASE_VERSION=$(node -p "require('./package.json').version")
          # Generate timestamp: YYYYMMDDHHMMSS
          TIMESTAMP=$(date -u +"%Y%m%d%H%M%S")
          # Create sandbox version
          SANDBOX_VERSION="${BASE_VERSION}-sandbox-${TIMESTAMP}"
          echo "SANDBOX_VERSION=${SANDBOX_VERSION}" >> $GITHUB_ENV
          # Update package.json version (no git commit)
          pnpm version "${SANDBOX_VERSION}" --no-git-tag-version
          echo "ğŸ“¦ Sandbox version: ${SANDBOX_VERSION}"

      - name: Configure NPM authentication
        run: pnpm config set "${{ secrets.NPM_AUTH_URL }}"

      - name: Publish to sandbox
        run: |
          pnpm publish -r \
            --registry "${{ secrets.NPM_REGISTRY_URL }}" \
            --no-git-checks \
            --report-summary \
            --tag sandbox

      - name: Send notification
        if: ${{ success() }}
        env:
          WEBHOOK_KEY: ${{ secrets.WEBHOOK_NOTIFY_API_KEY }}
        run: |
          # Skip if no webhook key configured
          if [ -z "$WEBHOOK_KEY" ]; then
            echo "No webhook key configured, skipping notification"
            exit 0
          fi

          # Get package info from package.json
          PKG_NAME=$(node -p "require('./package.json').name")
          PKG_VERSION=$(node -p "require('./package.json').version")

          # Build message
          MESSAGE="ğŸ“¦ Sandbox å‘å¸ƒæˆåŠŸ\n\nåŒ…å: ${PKG_NAME}\nç‰ˆæœ¬: ${PKG_VERSION}\nTag: sandbox\n\nå®‰è£…: pnpm add ${PKG_NAME}@sandbox"

          # Construct JSON payload
          DATA=$(cat <<EOF
          {
            "msgtype": "text",
            "text": {
              "content": "${MESSAGE}"
            }
          }
          EOF
          )

          # Send notification
          curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "$DATA" \
            "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=${WEBHOOK_KEY}"

          echo "Notification sent!"
